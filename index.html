<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>에나타 AI 샘</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      background: #000;
      font-family: 'Outfit', sans-serif;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 2em;
      text-shadow: 0 0 20px #fff59d;
      margin-bottom: 20px;
    }
    .question-area input {
      width: 90%;
      max-width: 500px;
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      outline: none;
    }
    .question-area button {
      margin-top: 10px;
      padding: 10px 30px;
      font-size: 16px;
      border-radius: 20px;
      background: #f4c363;
      border: none;
      cursor: pointer;
    }
    .cards {
      display: flex;
      justify-content: center;
      margin: 30px 0;
      gap: 16px;
    }
    .card {
      width: 100px;
      height: 160px;
      perspective: 1000px;
      cursor: pointer;
    }
    .card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s;
    }
    .card.flip .card-inner {
      transform: rotateY(180deg);
    }
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 10px;
    }
    .card-back {
      background: #f4e3c1 url('images/tarot_back.png') center/contain no-repeat;
    }
    .card-front {
      background: #fff;
      transform: rotateY(180deg);
    }
    .card.glow {
      box-shadow: 0 0 20px 8px gold;
      transform: scale(1.1);
      z-index: 10;
    }
    .card.blurred {
      opacity: 0.4;
      pointer-events: none;
    }
    .card.shake {
      animation: shake 0.5s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
    .spinner {
      display: none;
    }
    .result {
      max-width: 600px;
      margin: 0 auto;
      font-size: 16px;
      color: #fff9c4;
    }
    .consult-button {
      display: inline-block;
      margin-top: 20px;
      padding: 12px 24px;
      background: #f4c363;
      color: #000;
      border-radius: 24px;
      text-decoration: none;
      font-weight: bold;
    }
    #toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffcccc;
      color: #000;
      padding: 10px 20px;
      border-radius: 10px;
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>
  <h1>에나타 AI 샘</h1>
  <div id="toast">질문을 먼저 작성해주세요!</div>
  <div class="question-area">
    <input type="text" id="userQuestion" placeholder="질문을 입력하고 완료 버튼을 누르세요" />
    <button id="submitQuestion">완료</button>
  </div>
  <p class="instruction">질문 작성 후 한 장의 카드를 고르세요.</p>
  <div class="cards">
    <div class="card" onclick="selectCard(this, 0)"><div class="card-inner"><div class="card-back"></div><div class="card-front"><img /></div></div></div>
    <div class="card" onclick="selectCard(this, 1)"><div class="card-inner"><div class="card-back"></div><div class="card-front"><img /></div></div></div>
    <div class="card" onclick="selectCard(this, 2)"><div class="card-inner"><div class="card-back"></div><div class="card-front"><img /></div></div></div>
  </div>
  <div class="spinner" id="spinner">로딩중...</div>
  <div class="result" id="resultArea"></div>
  <a class="consult-button" href="https://m.booking.naver.com/booking/13/bizes/198330?theme=place&entry=pll" target="_blank">바로 상담하기</a>

  <script>
    const cardList = [
      { name: "The Fool", position: "정방향", meaning: "새로운 시작, 순수함, 모험심" },
      { name: "The Lovers", position: "정방향", meaning: "사랑, 조화, 관계의 조율" },
      { name: "The Star", position: "정방향", meaning: "희망, 영감, 치유" }
    ];

    let questionConfirmed = false;

    document.getElementById('submitQuestion').addEventListener('click', () => {
      const q = document.getElementById('userQuestion').value.trim();
      if (q) {
        questionConfirmed = true;
        alert("질문이 등록되었습니다. 카드를 선택해주세요!");
      } else {
        alert("질문을 입력해주세요.");
      }
    });

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2000);
    }

    function selectCard(cardElement, index) {
      const question = document.getElementById('userQuestion').value.trim();
      if (!question) {
        cardElement.classList.add('shake');
        showToast("질문을 먼저 작성해주세요!");
        return;
      }

      if (document.querySelector('.card.flip')) return; // 이미 선택됨

      const cards = document.querySelectorAll('.card');
      cards.forEach((card, i) => {
        card.classList.add('clicked');
        if (i === index) {
          const cardName = cardList[index].name.replaceAll(" ", "_") + ".png";
          const frontImg = card.querySelector(".card-front img");
          frontImg.src = "images/universal_tarot_images/" + cardName;
          card.classList.add('glow');
          setTimeout(() => {
            card.classList.add('flip');
            setTimeout(() => {
              callAPI(index);
            }, 800);
          }, 300);
        } else {
          card.classList.add('blurred');
        }
      });
    }

    async function callAPI(index) {
      const question = document.getElementById('userQuestion').value;
      const spinner = document.getElementById('spinner');
      const resultArea = document.getElementById('resultArea');
      const selectedCard = cardList[index];

      spinner.style.display = 'block';
      resultArea.style.display = 'block';
      resultArea.innerText = '';

      try {
        const response = await fetch('https://enata-tarot-api-v2.onrender.com/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question,
            cards: [{
              name: selectedCard.name,
              position: selectedCard.position,
              meaning: selectedCard.meaning
            }]
          })
        });
        const data = await response.json();
        spinner.style.display = 'none';
        typeText(resultArea, data.result);
      } catch (err) {
        spinner.style.display = 'none';
        resultArea.innerText = "문제가 발생했어요. 다시 시도해 주세요.";
      }
    }

    function typeText(element, text) {
      let i = 0;
      const speed = 25;
      function typing() {
        if (i < text.length) {
          element.innerText += text.charAt(i);
          i++;
          setTimeout(typing, speed);
        }
      }
      typing();
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
